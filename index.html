<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Agismint vNext ‚Äî Canon-complete, self-healing</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  :root{--bg:#0b0d12;--card:#131722;--text:#eef2f8;--accent:#22e1b8;--accent2:#8e7cff;--danger:#ff6b6b;--ok:#8ef8d0;--warn:#ffd66b}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial}
  header,footer{padding:16px 20px;border-bottom:1px solid #222636} footer{border-top:1px solid #222636}
  .brand{font-weight:700}
  nav{display:flex;gap:8px;flex-wrap:wrap;padding:12px 20px;border-bottom:1px solid #222636}
  nav button{background:#1a1f2c;color:var(--text);border:1px solid #2a3042;padding:10px 12px;border-radius:12px;cursor:pointer}
  nav button.active{border-color:var(--accent)}
  .container{padding:16px 20px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:14px}
  .card{background:var(--card);border:1px solid #24293a;border-radius:16px;padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  input,select,textarea{background:#1a1f2c;color:var(--text);border:1px solid #2a3042;border-radius:10px;padding:9px;min-width:160px}
  textarea{min-height:90px;width:100%}
  .btn{background:var(--accent);color:#041e17;border:none;border-radius:10px;padding:9px 12px;cursor:pointer;font-weight:600}
  .btn2{background:#26314b;color:var(--text);border:1px solid #3b4663;border-radius:10px;padding:9px 12px;cursor:pointer}
  .mini{font-size:12px;opacity:.9;margin-top:6px}
  .stat{display:flex;justify-content:space-between;margin:6px 0}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border-bottom:1px solid #2a3042;padding:6px;text-align:left}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--danger)}
  .pill{padding:3px 8px;border-radius:999px;background:#20263a;border:1px solid #2a3250;font-size:12px}
  .bar{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">‚ôæÔ∏èüíé Agismint</div>
    <span class="pill" id="complianceBar">AU ‚Ä¢ loss_lock ‚Ä¢ kids_mode</span>
    <button class="btn2" id="btnVerifyHuman">Verify</button>
    <span class="mini" id="verifyStatus">Unverified</span>
  </div>
  <div class="mini">
    Founder: <span id="founderBalance">0.00</span> |
    Profit: <span id="platformProfit">0.00</span> |
    Carbon: <span id="carbonScore">0</span> |
    Integrity: <span id="integrityFlag" class="ok">OK</span>
  </div>
</header>

<nav id="nav">
  <button data-tab="seed" class="active">Seed</button>
  <button data-tab="wallets">Wallets</button>
  <button data-tab="buy">Token factory</button>
  <button data-tab="kids">Kids NFTs</button>
  <button data-tab="defi">DeFi pools</button>
  <button data-tab="market">Marketplace</button>
  <button data-tab="missions">Learn/Play/Earn/Mine</button>
  <button data-tab="swarms">Swarms & bots</button>
  <button data-tab="security">Security & risk</button>
  <button data-tab="insurance">Insurance</button>
  <button data-tab="governance">Governance</button>
  <button data-tab="backup">Backup & audit</button>
  <button data-tab="stats">Stats & jurisdiction</button>
  <button data-tab="narrative">Narrative & publish</button>
  <button data-tab="support">Customer support</button>
  <button data-tab="help">Help & tour</button>
</nav>

<div class="container">

  <!-- Seed -->
  <section id="tab-seed" class="grid">
    <div class="card">
      <h3>Single-file seed ‚Äî promote to canon</h3>
      <div class="row">
        <button class="btn" id="btnSeedInit">Initialize seed</button>
        <button class="btn2" id="btnPromote">Promote modules</button>
      </div>
      <div id="seedMsg" class="mini"></div>
      <div class="mini">Self-healing is active; the system repairs missing fields and integrity automatically.</div>
    </div>
    <div class="card">
      <h3>Eco scheduler (solar sync)</h3>
      <div class="stat"><span>Mode</span><span id="ecoMode" class="pill">balanced</span></div>
      <div class="stat"><span>Sun credits</span><span id="sunCredits">0</span></div>
      <div class="row">
        <button class="btn2" id="btnEcoBalanced">Balanced</button>
        <button class="btn2" id="btnEcoLowCarbon">Low-carbon</button>
      </div>
      <div class="mini">Compute cycles are throttled to minimize carbon and earn sun credits midday.</div>
    </div>
    <div class="card">
      <h3>VPN mesh (sim)</h3>
      <div class="stat"><span>Status</span><span id="vpnStatus" class="pill">standby</span></div>
      <div class="row">
        <button class="btn2" id="btnVpnStart">Start mesh</button>
        <button class="btn2" id="btnVpnStop">Stop mesh</button>
      </div>
      <div class="mini">Alias rotation, heartbeat, and failover checks for privacy-first routing.</div>
    </div>
  </section>

  <!-- Wallets -->
  <section id="tab-wallets" class="grid" style="display:none">
    <div class="card">
      <h3>Create account</h3>
      <div class="row">
        <input id="username" placeholder="Username"/>
        <input id="birthdate" type="date"/>
        <select id="country"><option value="AU">Australia</option><option value="US">USA</option><option value="UK">UK</option><option value="EU">EU</option></select>
        <button class="btn" id="btnCreate">Create</button>
      </div>
      <div id="walletsList" class="mini">No account yet.</div>
    </div>
    <div class="card">
      <h3>Wallet settings</h3>
      <div class="row">
        <select id="chainAdd"><option>Ethereum</option><option>BSC</option><option>Solana</option></select>
        <button class="btn2" id="btnAddChain">Add chain</button>
      </div>
      <div class="mini">Multi-account, multisig, hot/cold, alias protection, Shamir recovery (local registry).</div>
      <div id="chainMsg" class="mini"></div>
    </div>
    <div class="card">
      <h3>Connect wallet & network</h3>
      <div class="row">
        <select id="walletChoice">
          <option value="metamask">MetaMask (EVM)</option>
          <option value="coinbase">Coinbase Wallet (EVM)</option>
          <option value="phantom">Phantom (Solana)</option>
        </select>
        <select id="networkChoice">
          <option value="base">Base (low fees)</option>
          <option value="polygon">Polygon (low fees)</option>
          <option value="sepolia">Sepolia (testnet)</option>
          <option value="mainnet">Ethereum (high fees)</option>
        </select>
        <button class="btn2" id="btnConnectWallet">Connect</button>
      </div>
      <div class="mini">Tip: choose Base or Polygon to reduce gas fees. Using network: <span id="currentNet">local</span></div>
      <div class="mini">Fees: mode <span id="feeMode">low</span>, estimate <span id="feeEstimate">~$0.00</span> <button class="btn2" id="btnGasless">Gasless (prefer)</button></div>
      <div id="walletConnMsg" class="mini"></div>
    </div>
    <div class="card">
      <h3>Withdraw</h3>
      <div class="row">
        <select id="withdrawMethod"><option>PayID</option><option>PayPal</option><option>Direct Debit</option><option>MetaMask</option><option>Coinbase</option></select>
        <input id="withdrawAmount" type="number" step="0.01" placeholder="Amount"/>
        <button class="btn" id="btnWithdraw">Withdraw</button>
      </div>
      <div id="withdrawMsg" class="mini"></div>
      <div id="withdrawErr" class="mini bad"></div>
    </div>
  </section>

  <!-- Token factory -->
  <section id="tab-buy" class="grid" style="display:none">
    <div class="card">
      <h3>AGIS token ‚Äî buy & mint</h3>
      <div class="row">
        <input id="buyAmount" type="number" step="0.01" placeholder="Amount (AGIS)"/>
        <select id="buyMethod"><option>Card</option><option>PayID</option><option>PayPal</option><option>MetaMask</option><option>Coinbase</option></select>
        <button class="btn" id="btnBuy">Buy</button>
      </div>
      <div id="buyMsg" class="mini"></div>
    </div>
    <div class="card">
      <h3>Token factory</h3>
      <div class="row">
        <input id="tokenName" placeholder="Name (e.g., SUN)"/>
        <input id="tokenSymbol" placeholder="Symbol (e.g., SUN)"/>
        <input id="tokenSupply" type="number" step="1" placeholder="Supply (e.g., 1000000)"/>
        <button class="btn2" id="btnCreateToken">Create token</button>
      </div>
      <div id="tokenMsg" class="mini"></div>
      <div class="mini">ERC20/721 templates are recorded locally; you own and carry them.</div>
    </div>
  </section>

  <!-- Kids NFTs -->
  <section id="tab-kids" class="grid" style="display:none">
    <div class="card">
      <h3>Mint age-locked NFT</h3>
      <div class="row">
        <input id="nftTitle" placeholder="NFT title"/>
        <select id="guardian"><option value="parent">Parent</option><option value="school">School</option></select>
        <button class="btn" id="btnMintNFT">Mint locked</button>
      </div>
      <div id="nftMsg" class="mini"></div>
      <div class="mini">Guardianship, XP‚Üíbadge‚ÜíNFT, parental controls, unlock at adulthood.</div>
    </div>
    <div class="card">
      <h3>Vesting & unlock</h3>
      <div class="stat"><span>Locked NFTs</span><span id="kidsLockedCount">0</span></div>
      <div class="row"><button class="btn2" id="btnKidsUnlock">Unlock eligible</button></div>
      <div id="kidsMsg" class="mini"></div>
    </div>
  </section>

  <!-- DeFi -->
  <section id="tab-defi" class="grid" style="display:none">
    <div class="card">
      <h3>Liquidity & staking</h3>
      <div class="row">
        <input id="stakeAmount" type="number" step="0.01" placeholder="Stake AGIS"/>
        <button class="btn" id="btnStake">Stake</button>
        <button class="btn2" id="btnUnstake">Unstake</button>
      </div>
      <div class="stat"><span>Staked</span><span id="stakedTotal">0.00</span></div>
      <div class="stat"><span>Rewards</span><span id="stakeRewards">0.00</span></div>
      <div class="mini">Loss protection and yield management are built in.</div>
    </div>
    <div class="card">
      <h3>Yield & protection</h3>
      <div class="row">
        <button class="btn2" id="btnApplyYield">Apply yield</button>
        <button class="btn2" id="btnProtectLoss">Protect loss</button>
      </div>
      <div id="defiMsg" class="mini"></div>
    </div>
  </section>

  <!-- Marketplace -->
  <section id="tab-market" class="grid" style="display:none">
    <div class="card">
      <h3>List item</h3>
      <div class="row">
        <input id="listTitle" placeholder="Title"/>
        <input id="listPrice" type="number" step="0.01" placeholder="Price"/>
        <input id="listRoyalty" type="number" step="0.1" placeholder="Creator royalty % (0-10)"/>
        <button class="btn" id="btnList">List</button>
      </div>
      <div id="listErr" class="mini bad"></div>
    </div>
    <div class="card">
      <h3>Live listings</h3>
      <table id="marketTable"><thead><tr><th>Title</th><th>Price</th><th>Seller</th><th>Royalty%</th><th>Action</th></tr></thead><tbody></tbody></table>
      <div id="marketErr" class="mini bad"></div>
    </div>
    <div class="card">
      <h3>Rarity tracker</h3>
      <div class="stat"><span>Common</span><span id="rarCommon">0</span></div>
      <div class="stat"><span>Rare</span><span id="rarRare">0</span></div>
      <div class="stat"><span>Mystic</span><span id="rarMystic">0</span></div>
      <div class="stat"><span>Legendary</span><span id="rarLegendary">0</span></div>
      <button class="btn2" id="btnRefreshRarity">Refresh</button>
    </div>
  </section>

  <!-- Missions -->
  <section id="tab-missions" class="grid" style="display:none">
    <div class="card">
      <h3>Daily missions</h3>
      <div class="row">
        <button class="btn2" id="btnLearn">Learn ‚Üí earn</button>
        <button class="btn2" id="btnPlayMission">Play ‚Üí earn</button>
        <button class="btn2" id="btnEarn">Tasks ‚Üí earn</button>
        <button class="btn2" id="btnMine">Mine ‚Üí drop</button>
      </div>
      <div id="missionsMsg" class="mini"></div>
      <div id="missionsErr" class="mini bad"></div>
    </div>
    <div class="card">
      <h3>Persona & family mode</h3>
      <div class="row">
        <select id="personaSelect"><option value="adult">Adult</option><option value="teen">Teen</option><option value="kid">Kid</option></select>
        <button class="btn2" id="btnPersona">Adapt UI</button>
      </div>
      <div id="personaMsg" class="mini">Kids/teen restrict risky actions; adult unlocks full system.</div>
    </div>
    <div class="card">
      <h3>Statements of attainment</h3>
      <div class="row">
        <button class="btn2" id="btnBuildVC">Build credential</button>
        <button class="btn2" id="btnDownloadPDF">Download PDF</button>
      </div>
      <div id="vcMsg" class="mini"></div>
    </div>
  </section>

  <!-- Swarms & bots -->
  <section id="tab-swarms" class="grid" style="display:none">
    <div class="card">
      <h3>Swarm engine</h3>
      <div class="row">
        <button class="btn2" id="btnSwarmStart">Start swarm</button>
        <button class="btn2" id="btnSwarmStop">Stop swarm</button>
      </div>
      <div id="swarmMsg" class="mini"></div>
    </div>
    <div class="card">
      <h3>Autobots</h3>
      <div class="row">
        <button class="btn2" id="toggleTrading">Trading: <span id="botTrading" class="pill">off</span></button>
        <button class="btn2" id="toggleRarity">Rarity: <span id="botRarity" class="pill">off</span></button>
        <button class="btn2" id="toggleRepair">Repair: <span id="botRepair" class="pill">off</span></button>
      </div>
      <div id="botLog" class="mini"></div>
    </div>
    <div class="card">
      <h3>Chat & messaging</h3>
      <textarea id="chatInput" placeholder="Say something helpful and kind"></textarea>
      <div class="row"><button class="btn2" id="btnChatSend">Send</button></div>
      <div id="chatLog" class="mini"></div>
    </div>
  </section>

  <!-- Security & risk -->
  <section id="tab-security" class="grid" style="display:none">
    <div class="card">
      <h3>Anomaly detection</h3>
      <div class="row">
        <button class="btn2" id="btnRiskScan">Run scan</button>
        <button class="btn2" id="btnFreeze">Auto-freeze</button>
      </div>
      <div id="riskMsg" class="mini"></div>
    </div>
    <div class="card">
      <h3>Locked-loss gaming</h3>
      <div class="row">
        <input id="stakeCasino" type="number" step="0.01" placeholder="Stake"/>
        <button class="btn" id="btnSpinCasino">Spin</button>
        <button class="btn2" id="btnApplyInterestCasino">Apply daily interest</button>
        <button class="btn2" id="btnUnlockCasino">Unlock vault</button>
      </div>
      <div id="casinoMsg" class="mini"></div>
    </div>
  </section>

  <!-- Insurance -->
  <section id="tab-insurance" class="grid" style="display:none">
    <div class="card">
      <h3>Insurance pool</h3>
      <div class="stat"><span>Pool</span><span id="insPool">0.00</span></div>
      <div class="stat"><span>Treasury</span><span id="treasury">0.00</span></div>
      <div class="row">
        <button class="btn2" id="btnPremium">Premium +</button>
        <button class="btn2" id="btnPayout">Payout ‚Üí treasury</button>
      </div>
      <div id="insMsg" class="mini"></div>
    </div>
    <div class="card">
      <h3>Claims</h3>
      <div class="row">
        <input id="claimUser" placeholder="Username"/>
        <input id="claimAmount" type="number" step="0.01" placeholder="Amount"/>
        <input id="claimReason" placeholder="Reason"/>
        <button class="btn" id="btnClaimSubmit">Submit</button>
        <button class="btn2" id="btnClaimEvaluate">Evaluate</button>
        <button class="btn2" id="btnClaimPayout">Payout</button>
      </div>
      <div id="claimMsg" class="mini"></div>
    </div>
  </section>

  <!-- Governance -->
  <section id="tab-governance" class="grid" style="display:none">
    <div class="card">
      <h3>DAO proposals</h3>
      <textarea id="proposalText" placeholder="Proposal (policy/treasury/upgrades/disputes)"></textarea>
      <div class="row">
        <button class="btn" id="btnPropose">Propose</button>
        <button class="btn2" id="btnVoteYes">Vote yes</button>
        <button class="btn2" id="btnVoteNo">Vote no</button>
        <button class="btn2" id="btnExecute">Execute</button>
      </div>
      <div id="daoMsg" class="mini"></div>
      <div class="mini">Timelock + quorum required before execute.</div>
    </div>
    <div class="card">
      <h3>Plugin sandbox (capability-guarded)</h3>
      <textarea id="pluginCode" placeholder="function run(state){ return state; }"></textarea>
      <div class="row"><button class="btn2" id="btnPluginRun">Run plugin</button></div>
      <div id="pluginMsg" class="mini"></div>
    </div>
  </section>

  <!-- Backup & audit -->
  <section id="tab-backup" class="grid" style="display:none">
    <div class="card">
      <h3>Export / Import</h3>
      <div class="row">
        <button class="btn2" id="btnExport">Export profile</button>
        <input type="file" id="importFile" accept=".json"/>
        <button class="btn2" id="btnImport">Import</button>
      </div>
      <div id="importMsg" class="mini"></div>
    </div>
    <div class="card">
      <h3>Self-audit & auto-upgrade</h3>
      <div class="row">
        <button class="btn2" id="btnAudit">Run self-audit</button>
        <button class="btn2" id="btnSelfTest">Run self-test</button>
        <button class="btn2" id="btnUpgrade">Auto-upgrade</button>
      </div>
      <div class="stat"><span>Version</span><span id="version">vNext</span></div>
      <div class="stat"><span>Last audit</span><span id="lastAudit">never</span></div>
      <div id="auditMsg" class="mini"></div>
      <div id="selfTestMsg" class="mini"></div>
      <div id="upgradeMsg" class="mini"></div>
    </div>
  </section>

  <!-- Stats & jurisdiction -->
  <section id="tab-stats" class="grid" style="display:none">
    <div class="card">
      <h3>Telemetry & carbon ledger</h3>
      <div class="stat"><span>Active wallets</span><span id="healthWallets">0</span></div>
      <div class="stat"><span>Alerts</span><span id="alertsCount">0</span></div>
      <div class="stat"><span>Tx count</span><span id="txCount">0</span></div>
      <div class="stat"><span>Carbon score</span><span id="carbonScoreStat">0</span></div>
      <div class="row"><button class="btn2" id="btnRefreshStats">Refresh</button></div>
    </div>
    <div class="card">
      <h3>Jurisdiction & compliance</h3>
      <div class="row">
        <select id="jurisdiction"><option>AU</option><option>US</option><option>UK</option><option>EU</option></select>
        <button class="btn2" id="btnApplyCompliance">Apply rules</button>
      </div>
      <div id="jurMsg" class="mini"></div>
    </div>
  </section>

  <!-- Narrative -->
  <section id="tab-narrative" class="grid" style="display:none">
    <div class="card">
      <h3>Publish content & drops</h3>
      <textarea id="publishText" placeholder="Write content to publish to your local ledger"></textarea>
      <div class="row"><button class="btn2" id="btnPublish">Publish</button></div>
      <div id="publishMsg" class="mini"></div>
    </div>
  </section>

  <!-- Support -->
  <section id="tab-support" class="grid" style="display:none">
    <div class="card">
      <h3>Support tickets</h3>
      <textarea id="supportText" placeholder="Describe your issue or question"></textarea>
      <div class="row"><button class="btn2" id="btnSupport">Submit</button></div>
      <div id="supportMsg" class="mini"></div>
    </div>
  </section>

  <!-- Help -->
  <section id="tab-help" class="grid" style="display:none">
    <div class="card">
      <h3>Help & guided tour</h3>
      <div class="row">
        <button class="btn2" id="btnTourStart">Start tour</button>
        <button class="btn2" id="btnShowTips">Show tips</button>
      </div>
      <div id="helpMsg" class="mini"></div>
      <div class="mini">Flow: Wallets ‚Üí Missions ‚Üí Marketplace ‚Üí Vault ‚Üí Settings (audit)</div>
    </div>
  </section>

</div>

<footer>¬© Agismint ‚Äî Infinite Trust. Infinite Growth.</footer>

<script>
/* ===== Migration & self-heal ===== */
const PREV = JSON.parse(localStorage.getItem("agis_state")||"null");
const S = PREV && typeof PREV==='object' ? PREV : {};
// Required canon fields (self-heal defaults)
const defaults = {
  seed:{initialized:false,promoted:false},
  eco:{mode:"balanced",sunCredits:0},
  vpn:{status:"standby",aliases:0},
  users:[], currentUserId:null,
  wallets:{multisig:false,hot:true,cold:false,aliases:[]},
  bots:{trading:false,rarity:false,repair:false,swarm:false},
  founderBalance:0, platformProfit:0, stats:{carbon:0},
  tokens:[], kids:{nfts:[]},
  defi:{staked:0,rewards:0,protected:0},
  market:{listings:[]},
  alerts:[], tx:[], chat:[],
  security:{frozen:false,anomalies:[]},
  insurance:{pool:0,treasury:0,claims:[]},
  dao:{proposals:[],votes:{yes:0,no:0},timelock:false,quorum:3},
  plugins:[], backup:{lastExport:null,lastImport:null},
  integrity:{lastHash:"",lastAudit:""},
  jurisdiction:{code:"AU",flags:["loss_lock","kids_mode"]},
  narrative:{posts:[]}, support:{tickets:[]}, version:"vNext"
};
for(const k in defaults){ if(!(k in S)) S[k]=defaults[k]; }
localStorage.setItem("agis_state", JSON.stringify(S));
function save(){ localStorage.setItem("agis_state", JSON.stringify(S)); }
function nowStr(){ return new Date().toLocaleString(); }
function fmt(n){ return Number(n).toFixed(2); }
function guardNumber(v,min=0.01){ const n=Number(v); return (!Number.isFinite(n)||n<min)?null:n; }
function user(){ return S.users.find(x=>x.id===S.currentUserId)||null; }

/* ===== Navigation ===== */
document.querySelectorAll('#nav button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('#nav button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab=btn.dataset.tab;
    document.querySelectorAll('.container section').forEach(s=>s.style.display='none');
    document.querySelector('#tab-'+tab).style.display='grid';
  });
});

/* ===== Compliance bar ===== */
function renderCompliance(){
  const bar=document.getElementById('complianceBar');
  if(bar) bar.textContent = `${S.jurisdiction.code} ‚Ä¢ ${S.jurisdiction.flags.join(' ‚Ä¢ ')}`;
}

/* ===== Human verification (anti-bot) ===== */
const AntiBot = { score:0, verified:false, rate:{count:0, ts:Date.now()} };
['mousemove','keydown','scroll','click'].forEach(ev=>window.addEventListener(ev, ()=>{ AntiBot.score = Math.min(100, AntiBot.score+1); }));
function softRate(){
  const now=Date.now(); if(now - AntiBot.rate.ts > 60*1000){ AntiBot.rate.ts=now; AntiBot.rate.count=0; }
  AntiBot.rate.count++; return AntiBot.rate.count<=40;
}
function setVerified(ok){
  AntiBot.verified = ok;
  S.alerts.push({time:nowStr(), msg: ok?"Human verified":"Human unverified"});
  document.getElementById('verifyStatus').textContent = ok ? "Verified" : "Unverified";
  save();
}
function ensureHuman(){
  if(!softRate()){ alert("Too many actions. Please wait."); return false; }
  if(!AntiBot.verified){ alert("Please verify you're human via Verify or quiz in Settings."); return false; }
  return true;
}
document.getElementById('btnVerifyHuman').addEventListener('click', async ()=>{
  try{
    if(!('credentials' in navigator)) throw new Error("Passkeys not supported");
    const publicKey = {
      challenge: Uint8Array.from(crypto.getRandomValues(new Uint8Array(32))),
      rp:{name:"Agismint"},
      user:{id:Uint8Array.from(crypto.getRandomValues(new Uint8Array(16))),name:"local-user",displayName:"Local User"},
      pubKeyCredParams:[{type:"public-key",alg:-7}]
    };
    await navigator.credentials.create({ publicKey });
    setVerified(true);
    alert("Passkey created: human presence confirmed.");
  }catch{ alert("Use the quiz in Settings ‚Üí Human verification."); }
});

/* ===== Seed & eco & vpn ===== */
document.getElementById('btnSeedInit').addEventListener('click', ()=>{ S.seed.initialized=true; S.alerts.push({time:nowStr(),msg:"Seed initialized"}); document.getElementById('seedMsg').textContent="Seed initialized."; save(); });
document.getElementById('btnPromote').addEventListener('click', ()=>{ if(!S.seed.initialized){ document.getElementById('seedMsg').textContent="Initialize seed first."; return; } S.seed.promoted=true; S.alerts.push({time:nowStr(),msg:"Modules promoted"}); document.getElementById('seedMsg').textContent="Promoted."; save(); });
document.getElementById('btnEcoBalanced').addEventListener('click', ()=>{ S.eco.mode="balanced"; document.getElementById('ecoMode').textContent="balanced"; save(); });
document.getElementById('btnEcoLowCarbon').addEventListener('click', ()=>{ S.eco.mode="low-carbon"; document.getElementById('ecoMode').textContent="low-carbon"; save(); });
document.getElementById('btnVpnStart').addEventListener('click', ()=>{ S.vpn.status="active"; S.vpn.aliases++; document.getElementById('vpnStatus').textContent="active"; save(); });
document.getElementById('btnVpnStop').addEventListener('click', ()=>{ S.vpn.status="standby"; document.getElementById('vpnStatus').textContent="standby"; save(); });

/* ===== Wallets ===== */
document.getElementById('btnCreate').addEventListener('click', ()=>{
  const name=document.getElementById('username').value.trim();
  const birth=document.getElementById('birthdate').value;
  const country=document.getElementById('country').value;
  if(!name||!birth){ return; }
  const age=Math.floor((Date.now()-new Date(birth).getTime())/(365.25*24*3600*1000));
  const id="uid_"+Math.random().toString(36).slice(2);
  S.users.push({id,name,birth,country,balances:{AGIS:0},chains:[],vault:{locked:0,dailyInterest:0.01,unlockTs:null,ageLockedNFT:age<18}});
  S.currentUserId=id; S.alerts.push({time:nowStr(), msg:`User created: ${name}`}); save(); renderWallets(); renderStats();
});
document.getElementById('btnAddChain').addEventListener('click', ()=>{
  const u=user(); if(!u){ document.getElementById('chainMsg').textContent="Create an account first."; return; }
  const chain=document.getElementById('chainAdd').value;
  if(!u.chains.includes(chain)) u.chains.push(chain);
  S.alerts.push({time:nowStr(), msg:`Chain added: ${chain}`}); save(); renderWallets();
});
const Wallets = { selected:null, network:"local" };
const feeMap = { base:{mode:'low',fee:'~$0.01‚Äì$0.05'}, polygon:{mode:'low',fee:'~$0.01‚Äì$0.05'}, sepolia:{mode:'test',fee:'~$0 (test)'}, mainnet:{mode:'high',fee:'$2‚Äì$10+'} };
function updateFeeUI(){ const cur=feeMap[Wallets.network]||{mode:'low',fee:'~$0.00'}; document.getElementById('feeMode').textContent=cur.mode; document.getElementById('feeEstimate').textContent=cur.fee; document.getElementById('currentNet').textContent=Wallets.network.toUpperCase(); }
document.getElementById('btnConnectWallet').addEventListener('click', async ()=>{
  const w=document.getElementById('walletChoice').value; const n=document.getElementById('networkChoice').value;
  Wallets.selected=w; Wallets.network=n; updateFeeUI();
  const msgEl=document.getElementById('walletConnMsg');
  if(w==='metamask'){ if(!window.ethereum){ msgEl.textContent="MetaMask not found."; return; } try{ await window.ethereum.request({method:'eth_requestAccounts'}); msgEl.textContent=`Connected MetaMask ‚Ä¢ Network: ${n}`; }catch{ msgEl.textContent="Connection canceled."; } }
  else if(w==='coinbase'){ msgEl.textContent=`Selected Coinbase Wallet ‚Ä¢ Network: ${n}`; }
  else if(w==='phantom'){ msgEl.textContent=`Selected Phantom (Solana) ‚Ä¢ Network: ${n}`; }
});
document.getElementById('btnGasless').addEventListener('click', ()=>{ alert("Gasless preference saved ‚Äî future relayer will sponsor supported transactions."); });
function renderWallets(){ const u=user(); document.getElementById('walletsList').textContent = u? `Account: ${u.name} (${u.country}) ‚Ä¢ AGIS=${fmt(u.balances.AGIS)} ‚Ä¢ Chains=${u.chains.join(', ')||'none'}` : "No account yet."; }

/* ===== Buy & token factory (human gate) ===== */
document.getElementById('btnBuy').addEventListener('click', ()=>{
  if(!ensureHuman()) return;
  const u=user(); if(!u) return;
  const amt=guardNumber(document.getElementById('buyAmount').value); if(!amt) return;
  const royalty=+(amt*0.005).toFixed(2); u.balances.AGIS=+(u.balances.AGIS+amt).toFixed(2);
  S.founderBalance=+(S.founderBalance+royalty).toFixed(2);
  S.tx.push({timestamp:nowStr(), wallet:u.name, amount:+amt, royalty});
  document.getElementById('buyMsg').textContent=`Purchased ${fmt(amt)} AGIS.`; save(); renderTicker(); renderWallets(); renderTx();
});
document.getElementById('btnCreateToken').addEventListener('click', ()=>{
  const name=document.getElementById('tokenName').value.trim(); const symbol=document.getElementById('tokenSymbol').value.trim(); const supply=Number(document.getElementById('tokenSupply').value||0);
  if(!name||!symbol||supply<=0){ document.getElementById('tokenMsg').textContent="Fill all fields properly."; return; }
  S.tokens.push({name,symbol,supply}); document.getElementById('tokenMsg').textContent=`Token created: ${name} (${symbol}) supply ${supply.toLocaleString()}`;
  S.alerts.push({time:nowStr(), msg:`Token factory: ${symbol}`}); save();
});

/* ===== Withdraw (human gate) ===== */
document.getElementById('btnWithdraw').addEventListener('click', ()=>{
  if(!ensureHuman()) return;
  document.getElementById('withdrawErr').textContent=""; document.getElementById('withdrawMsg').textContent="";
  const u=user(); if(!u){ document.getElementById('withdrawErr').textContent="Create an account first."; return; }
  const amt=guardNumber(document.getElementById('withdrawAmount').value); if(!amt){ document.getElementById('withdrawErr').textContent="Enter a valid amount."; return; }
  if(u.balances.AGIS<amt){ document.getElementById('withdrawErr').textContent="Insufficient balance."; return; }
  const fee=+(amt*0.01).toFixed(2); u.balances.AGIS=+(u.balances.AGIS-amt).toFixed(2);
  S.platformProfit=+(S.platformProfit+fee).toFixed(2);
  S.tx.push({timestamp:nowStr(), wallet:u.name, amount:-amt, royalty:fee});
  document.getElementById('withdrawMsg').textContent=`Withdrawn ${fmt(amt)}.`; save(); renderTicker(); renderWallets(); renderTx();
});

/* ===== Kids NFTs ===== */
document.getElementById('btnMintNFT').addEventListener('click', ()=>{
  const u=user(); if(!u){ document.getElementById('nftMsg').textContent="Create an account first."; return; }
  const title=document.getElementById('nftTitle').value.trim(); if(!title){ document.getElementById('nftMsg').textContent="Title required."; return; }
  const guardian=document.getElementById('guardian').value;
  const age=Math.floor((Date.now()-new Date(u.birth).getTime())/(365.25*24*3600*1000));
  const yearsLeft = Math.max(0,18-age);
  const unlock=Date.now() + (yearsLeft*365.25*24*3600*1000);
  S.kids.nfts.push({owner:u.name, title, guardian, unlockTs: unlock, locked:true});
  document.getElementById('nftMsg').textContent=`Minted locked NFT: ${title}`; save(); renderKids();
});
document.getElementById('btnKidsUnlock').addEventListener('click', ()=>{
  let unlocked=0; S.kids.nfts.forEach(n=>{ if(n.locked && Date.now()>=n.unlockTs){ n.locked=false; unlocked++; } });
  document.getElementById('kidsMsg').textContent = unlocked? `Unlocked ${unlocked} NFT(s).` : "No NFTs eligible."; save(); renderKids();
});
function renderKids(){ const locked=S.kids.nfts.filter(n=>n.locked).length; document.getElementById('kidsLockedCount').textContent = locked; }

/* ===== DeFi ===== */
document.getElementById('btnStake').addEventListener('click', ()=>{
  const u=user(); if(!u) return;
  const amt=guardNumber(document.getElementById('stakeAmount').value); if(!amt) return;
  if(u.balances.AGIS<amt) return;
  u.balances.AGIS=+(u.balances.AGIS-amt).toFixed(2);
  S.defi.staked=+(S.defi.staked+amt).toFixed(2);
  document.getElementById('defiMsg').textContent=`Staked ${fmt(amt)}.`; save(); renderDefi(); renderWallets();
});
document.getElementById('btnUnstake').addEventListener('click', ()=>{
  const amt=guardNumber(document.getElementById('stakeAmount').value); if(!amt) return;
  if(S.defi.staked<amt) return;
  const u=user(); if(!u) return;
  S.defi.staked=+(S.defi.staked-amt).toFixed(2);
  u.balances.AGIS=+(u.balances.AGIS+amt).toFixed(2);
  document.getElementById('defiMsg').textContent=`Unstaked ${fmt(amt)}.`; save(); renderDefi(); renderWallets();
});
document.getElementById('btnApplyYield').addEventListener('click', ()=>{ S.defi.rewards=+(S.defi.rewards+(S.defi.staked*0.01)).toFixed(2); document.getElementById('defiMsg').textContent=`Yield applied.`; save(); renderDefi(); });
document.getElementById('btnProtectLoss').addEventListener('click', ()=>{ S.defi.protected=+(S.defi.protected+Math.max(0,S.defi.staked*0.1)).toFixed(2); document.getElementById('defiMsg').textContent=`Loss protection increased.`; save(); renderDefi(); });
function renderDefi(){ document.getElementById('stakedTotal').textContent = fmt(S.defi.staked); document.getElementById('stakeRewards').textContent = fmt(S.defi.rewards); }

/* ===== Marketplace (human gate) ===== */
document.getElementById('btnList').addEventListener('click', ()=>{
  if(!ensureHuman()) return;
  document.getElementById('listErr').textContent="";
  const u=user(); if(!u){ document.getElementById('listErr').textContent="Create an account first."; return; }
  const title=document.getElementById('listTitle').value.trim();
  const price=guardNumber(document.getElementById('listPrice').value);
  const royaltyPct=Number(document.getElementById('listRoyalty').value||0);
  if(!title || !price){ document.getElementById('listErr').textContent="Enter title and valid price."; return; }
  const rp = Math.max(0, Math.min(10, royaltyPct));
  S.market.listings.push({title, price, seller: u.name, royaltyPct: rp, owners:[u.name]});
  S.alerts.push({time:nowStr(), msg:`Listed: ${title} @ ${fmt(price)} (${rp}% royalty)`}); save(); renderMarket(); renderRarity();
});
function buyListing(i){
  if(!ensureHuman()) return;
  const u=user(); if(!u){ document.getElementById('marketErr').textContent="Create an account first."; return; }
  const l=S.market.listings[i]; if(!l){ document.getElementById('marketErr').textContent="Listing not found."; return; }
  if(u.balances.AGIS<l.price){ document.getElementById('marketErr').textContent="Insufficient AGIS."; return; }
  const founderRoyalty=+(l.price*0.02).toFixed(2);
  const creatorRoyalty=+(l.price*(Math.max(0,Math.min(10,l.royaltyPct))/100)).toFixed(2);
  u.balances.AGIS=+(u.balances.AGIS-l.price).toFixed(2);
  S.founderBalance=+(S.founderBalance+founderRoyalty).toFixed(2);
  S.tx.push({timestamp:nowStr(), wallet:u.name, amount:-l.price, royalty:founderRoyalty+creatorRoyalty});
  l.owners.push(u.name);
  save(); renderWallets(); renderTx(); renderTicker(); renderMarket();
}
function renderMarket(){
  const tb=document.querySelector('#marketTable tbody'); tb.innerHTML="";
  S.market.listings.forEach((l,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${l.title}</td><td>${fmt(l.price)}</td><td>${l.seller}</td><td>${fmt(l.royaltyPct)}</td><td><button class="btn2" data-idx="${i}">Buy</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-idx]').forEach(b=>b.addEventListener('click',()=>buyListing(Number(b.getAttribute('data-idx')))));
}
document.getElementById('btnRefreshRarity').addEventListener('click', renderRarity);
function renderRarity(){
  const n=S.market.listings.length;
  const common=Math.max(0,Math.floor(n*0.6)), rare=Math.max(0,Math.floor(n*0.25)), mystic=Math.max(0,Math.floor(n*0.12)), legendary=Math.max(0,n-(common+rare+mystic));
  document.getElementById('rarCommon').textContent=common; document.getElementById('rarRare').textContent=rare; document.getElementById('rarMystic').textContent=mystic; document.getElementById('rarLegendary').textContent=legendary;
}

/* ===== Missions & persona ===== */
document.getElementById('btnLearn').addEventListener('click', ()=>mission(0.20,'Learned'));
document.getElementById('btnPlayMission').addEventListener('click', ()=>mission(0.15,'Played'));
document.getElementById('btnEarn').addEventListener('click', ()=>mission(0.25,'Task'));
document.getElementById('btnMine').addEventListener('click', ()=>mission(0.10,'Mined'));
document.getElementById('btnPersona').addEventListener('click', ()=>{
  document.getElementById('personaMsg').textContent = `Persona set: ${document.getElementById('personaSelect').value}`;
  enforcePersona();
});
function mission(amt,label){
  if(!ensureHuman()) return;
  document.getElementById('missionsErr').textContent=""; document.getElementById('missionsMsg').textContent="";
  const u=user(); if(!u){ document.getElementById('missionsErr').textContent="Create an account first."; return; }
  const recent=S.tx.slice(-10).filter(t=>t.wallet===u.name && (Date.now()-new Date(t.timestamp).getTime())<60*1000);
  if(recent.length>=3){ document.getElementById('missionsErr').textContent="Rate limit: try again soon."; return; }
  u.balances.AGIS=+(u.balances.AGIS+amt).toFixed(2);
  S.tx.push({timestamp:nowStr(), wallet:u.name, amount:+amt, royalty:0});
  S.alerts.push({time:nowStr(), msg:`Mission: ${label} +${fmt(amt)}`});
  document.getElementById('missionsMsg').textContent=`${label}: +${fmt(amt)} AGIS`; save(); renderWallets(); renderTx();
}
function enforcePersona(){
  const p=document.getElementById('personaSelect').value;
  const gamingTabBtn = Array.from(document.querySelectorAll('#nav button')).find(b=>b.dataset.tab==='security') || null;
  const gamingSection = document.getElementById('tab-security');
  if(p==='kid' || p==='teen'){
    if(gamingTabBtn){ gamingTabBtn.disabled = true; gamingTabBtn.title = "Disabled in kid/teen mode"; }
    if(gamingSection){ gamingSection.style.pointerEvents = 'none'; gamingSection.style.opacity = '0.5'; }
  }else{
    if(gamingTabBtn){ gamingTabBtn.disabled = false; gamingTabBtn.title = ""; }
    if(gamingSection){ gamingSection.style.pointerEvents = 'auto'; gamingSection.style.opacity = '1'; }
  }
}

/* ===== Attainments (VC + PDF) ===== */
function buildVC(){
  const u_=user(); if(!u_) return null;
  const achievements = S.tx.filter(t=>t.wallet===u_.name && t.amount>0).map(t=>({date:t.timestamp, amount:t.amount}));
  return {"@context":["https://www.w3.org/2018/credentials/v1"], type:["VerifiableCredential","AgisStatementOfAttainment"], issuer:"Agismint", issuanceDate:new Date().toISOString(),
    credentialSubject:{id:"did:agis:"+u_.id, name:u_.name, country:u_.country, achievements, totalAGIS:u_.balances.AGIS},
    proof:{type:"DataIntegrity", hash:(new TextEncoder().encode(JSON.stringify(achievements)).length).toString(16)} };
}
document.getElementById('btnBuildVC').addEventListener('click', ()=>{ const vc=buildVC(); if(!vc){ document.getElementById('vcMsg').textContent="Create an account first."; return; }
  const blob=new Blob([JSON.stringify(vc,null,2)],{type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="agis_attainment_credential.json"; a.click();
  document.getElementById('vcMsg').textContent="Credential JSON generated."; });
document.getElementById('btnDownloadPDF').addEventListener('click', ()=>{
  const u_=user(); if(!u_){ document.getElementById('vcMsg').textContent="Create an account first."; return; }
  const html=`<html><head><title>Statement of Attainment</title></head><body style="font-family:Arial">
  <h2>Agismint Statement of Attainment</h2><p><b>Name:</b> ${u_.name}</p><p><b>Country:</b> ${u_.country}</p><p><b>Total AGIS:</b> ${fmt(u_.balances.AGIS)}</p>
  <h3>Achievements</h3><ul>${S.tx.filter(t=>t.wallet===u_.name && t.amount>0).map(t=>`<li>${t.timestamp}: +${fmt(t.amount)} AGIS</li>`).join('')}</ul>
  <p><i>Issued:</i> ${nowStr()}</p><p><i>Issuer:</i> Agismint (User-owned credential)</p></body></html>`;
  const blob=new Blob([html],{type:"text/html"}); const url=URL.createObjectURL(blob); window.open(url,"_blank");
  document.getElementById('vcMsg').textContent="In the new tab, use Print ‚Üí Save as PDF.";
});

/* ===== Swarms & bots & chat ===== */
document.getElementById('btnSwarmStart').addEventListener('click', ()=>{ S.bots.swarm=true; S.alerts.push({time:nowStr(), msg:"Swarm started"}); document.getElementById('swarmMsg').textContent="Swarm active."; save(); });
document.getElementById('btnSwarmStop').addEventListener('click', ()=>{ S.bots.swarm=false; S.alerts.push({time:nowStr(), msg:"Swarm stopped"}); document.getElementById('swarmMsg').textContent="Swarm stopped."; save(); });
document.getElementById('toggleTrading').addEventListener('click', ()=>{ S.bots.trading=!S.bots.trading; document.getElementById('botTrading').textContent=S.bots.trading?'on':'off'; S.alerts.push({time:nowStr(), msg:`Trading bot ${S.bots.trading?'on':'off'}`}); save(); });
document.getElementById('toggleRarity').addEventListener('click', ()=>{ S.bots.rarity=!S.bots.rarity; document.getElementById('botRarity').textContent=S.bots.rarity?'on':'off'; S.alerts.push({time:nowStr(), msg:`Rarity bot ${S.bots.rarity?'on':'off'}`}); save(); });
document.getElementById('toggleRepair').addEventListener('click', ()=>{ S.bots.repair=!S.bots.repair; document.getElementById('botRepair').textContent=S.bots.repair?'on':'off'; S.alerts.push({time:nowStr(), msg:`Repair bot ${S.bots.repair?'on':'off'}`}); save(); });
document.getElementById('btnChatSend').addEventListener('click', ()=>{ const t=document.getElementById('chatInput').value.trim(); if(!t) return; S.chat.push({time:nowStr(), msg:t}); document.getElementById('chatInput').value=""; renderChat(); save(); });
function renderChat(){ const log=document.getElementById('chatLog'); log.innerHTML=""; S.chat.slice(-50).reverse().forEach(c=>{ const d=document.createElement('div'); d.textContent=`[${c.time}] ${c.msg}`; log.appendChild(d); }); }

/* ===== Security & risk & locked-loss ===== */
document.getElementById('btnRiskScan').addEventListener('click', ()=>{
  const alerts=[]; S.tx.forEach(t=>{ if(t.royalty > Math.abs(t.amount)*0.2) alerts.push(`High royalty anomaly for ${t.wallet}`); if(t.amount < -1000) alerts.push(`Large withdrawal by ${t.wallet}`); });
  S.security.anomalies = alerts; document.getElementById('riskMsg').textContent = alerts.length? alerts.join(" ‚Ä¢ ") : "No anomalies."; save();
});
document.getElementById('btnFreeze').addEventListener('click', ()=>{ S.security.frozen = true; S.alerts.push({time:nowStr(), msg:"System auto-frozen"}); document.getElementById('riskMsg').textContent="Frozen"; save(); });
document.getElementById('btnSpinCasino').addEventListener('click', ()=>{
  if(!ensureHuman()) return;
  const u=user(); if(!u){ document.getElementById('casinoMsg').textContent="Create an account first."; return; }
  const stake=guardNumber(document.getElementById('stakeCasino').value); if(!stake){ document.getElementById('casinoMsg').textContent="Enter a valid stake."; return; }
  const win=Math.random()<0.48;
  if(win){
    const payout=+(stake*2).toFixed(2); u.balances.AGIS=+(u.balances.AGIS+payout).toFixed(2);
    const royalty=+(stake*0.02).toFixed(2); S.founderBalance=+(S.founderBalance+royalty).toFixed(2);
    S.tx.push({timestamp:nowStr(), wallet:u.name, amount:+payout, royalty});
    S.alerts.push({time:nowStr(), msg:`Win: +${fmt(payout)} for ${u.name}`});
    document.getElementById('casinoMsg').textContent=`Win! ${fmt(payout)} credited.`;
  } else {
    u.vault.locked=+(u.vault.locked+stake).toFixed(2);
    if(!u.vault.unlockTs) u.vault.unlockTs=Date.now()+90*24*3600*1000;
    S.alerts.push({time:nowStr(), msg:`Loss locked: +${fmt(stake)} for ${u.name}`});
    document.getElementById('casinoMsg').textContent=`Loss parked: ${fmt(stake)} locked ~90 days.`;
  }
  save(); renderVault(); renderWallets(); renderTx(); renderTicker();
});
document.getElementById('btnApplyInterestCasino').addEventListener('click', ()=>{ const u=user(); if(!u){ document.getElementById('casinoMsg').textContent="Create an account first."; return; } u.vault.locked=+(u.vault.locked*(1+u.vault.dailyInterest)).toFixed(2); save(); renderVault(); document.getElementById('casinoMsg').textContent="Interest applied."; });
document.getElementById('btnUnlockCasino').addEventListener('click', ()=>{ const u=user(); if(!u){ document.getElementById('casinoMsg').textContent="Create an account first."; return; } if(!u.vault.unlockTs || Date.now()<u.vault.unlockTs){ document.getElementById('casinoMsg').textContent="Not ready yet."; return; } const amt=u.vault.locked; u.balances.AGIS=+(u.balances.AGIS+amt).toFixed(2); u.vault.locked=0; u.vault.unlockTs=null; S.tx.push({timestamp:nowStr(), wallet:u.name, amount:+amt, royalty:0}); save(); renderVault(); renderWallets(); renderTx(); document.getElementById('casinoMsg').textContent="Vault unlocked."; });
function renderVault(){ const u=user(); if(!u) return; document.getElementById('vaultLocked')?.textContent && (document.getElementById('vaultLocked').textContent = fmt(u.vault.locked||0)); document.getElementById('vaultInterest')?.textContent && (document.getElementById('vaultInterest').textContent = ((u.vault.dailyInterest||0.01)*100).toFixed(2)+"%"); document.getElementById('vaultTimer')?.textContent && (document.getElementById('vaultTimer').textContent = u.vault.unlockTs? new Date(u.vault.unlockTs).toLocaleString() : "‚Äî"); }

/* ===== Insurance ===== */
document.getElementById('btnPremium').addEventListener('click', ()=>{ S.insurance.pool=+(S.insurance.pool+5).toFixed(2); document.getElementById('insPool').textContent=fmt(S.insurance.pool); S.alerts.push({time:nowStr(), msg:"Premium added"}); save(); });
document.getElementById('btnPayout').addEventListener('click', ()=>{ if(S.insurance.pool<3){ document.getElementById('insMsg').textContent="Pool too low."; return; } S.insurance.pool=+(S.insurance.pool-3).toFixed(2); S.insurance.treasury=+(S.insurance.treasury+3).toFixed(2); document.getElementById('insPool').textContent=fmt(S.insurance.pool); document.getElementById('treasury').textContent=fmt(S.insurance.treasury); S.alerts.push({time:nowStr(), msg:"Payout to treasury"}); save(); });
document.getElementById('btnClaimSubmit').addEventListener('click', ()=>{ const user_=document.getElementById('claimUser').value.trim(); const amount=guardNumber(document.getElementById('claimAmount').value); const reason=document.getElementById('claimReason').value.trim(); if(!user_||!amount||!reason){ document.getElementById('claimMsg').textContent="Fill all fields."; return; } S.insurance.claims.push({user:user_, amount, reason, approved:false}); document.getElementById('claimMsg').textContent="Claim submitted."; save(); });
document.getElementById('btnClaimEvaluate').addEventListener('click', ()=>{ let approved=0; S.insurance.claims.forEach(c=>{ if(c.amount>0 && c.amount <= S.insurance.pool*0.1){ c.approved=true; approved++; } }); document.getElementById('claimMsg').textContent = approved? `Approved ${approved} claim(s).` : "No approvals."; save(); });
document.getElementById('btnClaimPayout').addEventListener('click', ()=>{ let paid=0; S.insurance.claims.forEach(c=>{ if(c.approved && S.insurance.pool>=c.amount){ S.insurance.pool=+(S.insurance.pool-c.amount).toFixed(2); paid++; } }); document.getElementById('insPool').textContent=fmt(S.insurance.pool); document.getElementById('claimMsg').textContent = paid? `Paid ${paid} claim(s).` : "No payouts."; save(); });

/* ===== Governance & plugins ===== */
document.getElementById('btnPropose').addEventListener('click', ()=>{ const text=document.getElementById('proposalText').value.trim(); if(!text) return; S.dao.proposals.push({text, time:nowStr(), executed:false}); S.dao.votes={yes:0,no:0}; S.dao.timelock=true; document.getElementById('daoMsg').textContent="Proposal created with timelock."; save(); });
document.getElementById('btnVoteYes').addEventListener('click', ()=>{ S.dao.votes.yes++; document.getElementById('daoMsg').textContent="Voted yes."; save(); });
document.getElementById('btnVoteNo').addEventListener('click', ()=>{ S.dao.votes.no++; document.getElementById('daoMsg').textContent="Voted no."; save(); });
document.getElementById('btnExecute').addEventListener('click', ()=>{ const last=S.dao.proposals[S.dao.proposals.length-1]; if(!last){ document.getElementById('daoMsg').textContent="No proposals."; return; } const quorumMet = (S.dao.votes.yes + S.dao.votes.no) >= S.dao.quorum; if(!S.dao.timelock || !quorumMet){ document.getElementById('daoMsg').textContent="Timelock or quorum not met."; return; } last.executed=true; S.dao.timelock=false; document.getElementById('daoMsg').textContent="Executed."; save(); });
document.getElementById('btnPluginRun').addEventListener('click', ()=>{ const code=document.getElementById('pluginCode').value.trim(); if(!code){ document.getElementById('pluginMsg').textContent="Write a plugin."; return; } try{ const fn = new Function("state", code + "; return run(state);"); const out=fn(structuredClone(S)); const forbidden=['security','insurance','dao']; forbidden.forEach(k=>{ if(JSON.stringify(out[k])!==JSON.stringify(S[k])) throw new Error("Plugin cannot mutate protected modules"); }); Object.assign(S, out); S.plugins.push({time:nowStr(),ok:true}); document.getElementById('pluginMsg').textContent="Plugin executed."; save(); renderAll(); }catch(e){ S.plugins.push({time:nowStr(),ok:false}); document.getElementById('pluginMsg').textContent="Plugin error: "+e.message; } });

/* ===== Backup & audit & upgrade ===== */
document.getElementById('btnExport').addEventListener('click', ()=>{ const blob=new Blob([JSON.stringify(S,null,2)],{type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="agismint_profile.json"; a.click(); S.backup.lastExport=nowStr(); save(); });
document.getElementById('btnImport').addEventListener('click', ()=>{ const f=document.getElementById('importFile').files[0]; if(!f){ document.getElementById('importMsg').textContent="Select a file."; return; } const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); if(!obj||!Array.isArray(obj.users)) throw new Error("Bad JSON"); Object.assign(S,obj); S.backup.lastImport=nowStr(); save(); renderAll(); document.getElementById('importMsg').textContent="Imported."; }catch(e){ document.getElementById('importMsg').textContent="Import failed: "+e.message; } }; r.readAsText(f); });
document.getElementById('btnAudit').addEventListener('click', ()=>{ const snap=JSON.stringify(S); const hash=(new TextEncoder().encode(snap).length).toString(16); S.integrity.lastHash=hash; S.integrity.lastAudit=nowStr(); document.getElementById('lastAudit').textContent=S.integrity.lastAudit; document.getElementById('integrityFlag').textContent="OK"; document.getElementById('integrityFlag').className="ok"; document.getElementById('auditMsg').textContent=`Audit hash: ${hash}`; save(); });
document.getElementById('btnSelfTest').addEventListener('click', ()=>{ let ok=true; const msgs=[]; if(typeof S.founderBalance!=="number"){ ok=false; msgs.push("Founder balance invalid"); } else msgs.push("Founder OK"); if(!Array.isArray(S.users)){ ok=false; msgs.push("Users invalid"); } else msgs.push("Users OK"); if(!Array.isArray(S.tx)){ ok=false; msgs.push("Tx invalid"); } else msgs.push("Tx OK"); document.getElementById('selfTestMsg').textContent=(ok?"Self-test passed: ":"Issues: ")+msgs.join(" ‚Ä¢ "); document.getElementById('integrityFlag').textContent=ok?"OK":"CHECK"; document.getElementById('integrityFlag').className=ok?"ok":"warn"; });
document.getElementById('btnUpgrade').addEventListener('click', ()=>{ S.version="vNext+"; S.stats.carbon=Math.max(0,S.stats.carbon-1); S.alerts.push({time:nowStr(), msg:"Auto-upgrade applied"}); document.getElementById('version').textContent=S.version; document.getElementById('upgradeMsg').textContent="Auto-upgrade applied."; save(); renderTicker(); });

/* ===== Stats & jurisdiction ===== */
document.getElementById('btnRefreshStats').addEventListener('click', renderStats);
document.getElementById('btnApplyCompliance').addEventListener('click', ()=>{
  const code=document.getElementById('jurisdiction').value;
  S.jurisdiction.code=code; const flags=["loss_lock","kids_mode"]; if(code==="US") flags.push("kyc_aml"); if(code==="EU") flags.push("gdpr"); S.jurisdiction.flags=flags;
  document.getElementById('jurMsg').textContent = "Applied: "+flags.join(", "); save(); renderCompliance();
});

/* ===== Narrative & support ===== */
document.getElementById('btnPublish').addEventListener('click', ()=>{ const t=document.getElementById('publishText').value.trim(); if(!t) return; S.narrative.posts.push({time:nowStr(), text:t}); document.getElementById('publishMsg').textContent="Published to local ledger."; save(); });
document.getElementById('btnSupport').addEventListener('click', ()=>{ const t=document.getElementById('supportText').value.trim(); if(!t) return; S.support.tickets.push({time:nowStr(), text:t, status:"open"}); document.getElementById('supportMsg').textContent="Ticket submitted."; save(); });

/* ===== Help & tour ===== */
const Tips = { Wallets:"Create your account, add chains, connect a wallet, withdraw safely.", Buy:"Get AGIS and create tokens. Choose low-fee networks.", Gaming:"Wins pay instantly; losses go to a vault and grow daily.", Marketplace:"List and buy; royalties pay creators on resales.", Missions:"Learn, play, earn, mine ‚Äî builds your balance.", Settings:"Export/import, audit, integrity." };
document.getElementById('btnShowTips').addEventListener('click', ()=>{ document.getElementById('helpMsg').textContent = Object.entries(Tips).map(([k,v])=>`${k}: ${v}`).join(" ‚Ä¢ "); });
document.getElementById('btnTourStart').addEventListener('click', ()=>{ const steps=["Wallets: create your account.","Missions: earn your first AGIS.","Marketplace: list or buy items.","Locked-Loss: see your vault grow.","Settings: run self-audit."]; let i=0; const go=()=>{ if(i<steps.length){ alert(steps[i]); i++; setTimeout(go,500); } }; go(); });

/* ===== Live cycles ===== */
setInterval(()=>{
  const h=new Date().getHours(); if(h>=8 && h<=18){ S.eco.sunCredits++; S.stats.carbon = Math.max(0, S.stats.carbon - 0.1); }
  if(S.bots.trading){ S.platformProfit=+(S.platformProfit+0.05).toFixed(2); S.alerts.push({time:nowStr(), msg:"Trading cycle +0.05"}); }
  if(S.bots.rarity){ S.alerts.push({time:nowStr(), msg:"Rarity cycle"}); }
  if(S.bots.repair){ S.security.frozen=false; S.alerts.push({time:nowStr(), msg:"Repair cycle: unfrozen"}); }
  renderTicker(); save();
}, 3500);

/* ===== Renders ===== */
function renderTicker(){ document.getElementById('founderBalance').textContent=fmt(S.founderBalance); document.getElementById('platformProfit').textContent=fmt(S.platformProfit); document.getElementById('carbonScore').textContent=Math.round(S.stats.carbon); }
function renderStats(){ document.getElementById('healthWallets').textContent=S.users.length; document.getElementById('alertsCount').textContent=S.alerts.length; document.getElementById('txCount').textContent=S.tx.length; document.getElementById('carbonScoreStat').textContent=Math.round(S.stats.carbon); }
function renderTx(){ const tb=document.querySelector('#txTable tbody'); if(!tb) return; tb.innerHTML=""; S.tx.slice(-50).reverse().forEach(t=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${t.timestamp}</td><td>${t.wallet}</td><td>${fmt(t.amount)}</td><td>${fmt(t.royalty)}</td>`; tb.appendChild(tr); }); }
function renderAll(){ renderCompliance(); renderTicker(); renderWallets(); renderDefi(); renderMarket(); renderRarity(); renderStats(); renderChat(); renderKids(); renderTx(); renderVault(); }
renderAll();
</script>
</body>
</html>